# 事件文本处理与倒排索引系统实验报告

## 一、事件文本处理器

`EventTextProcessor` 类整合了 XML 解析、文本分词和 Token 规范化功能，实现完整的文本预处理流程。

### 核心功能

**XML 解析与文本分词**：使用 `xml.etree.ElementTree` 解析 XML 文件，通过 `nltk.tokenize.word_tokenize()` 分词，支持多词短语识别（用下划线连接）。

**Token 过滤与规范化**：结合 `nltk.corpus.stopwords` 过滤停用词和标点，使用 `nltk.pos_tag()` 进行词性标注，通过 `WordNetLemmatizer` 进行词形还原。

**并行处理**：采用 `ProcessPoolExecutor` 实现多进程并行处理，提升大规模数据处理效率。

---

## 二、倒排索引构建

`InvertedIndexBuilder` 类实现完整的倒排索引构建流程，支持多种存储格式。

### 构建流程

采用三步法构建索引：(1) 构建临时索引（提取 `<词项, 文档ID>` 对）→ (2) 排序与合并（按词项排序并合并倒排列表）→ (3) 生成索引文件（支持文本、二进制、压缩格式）。

### 存储格式

**文本格式**：明文存储，可读性强，便于调试。

**二进制格式**：使用 `struct.pack('I', doc_id)` 将文档ID打包为4字节无符号整数，支持快速随机访问。

**VB+Gap 压缩**：Gap编码将文档ID转换为差值，VB（Variable Byte）编码使用可变字节表示整数，小数字占用更少字节。

**K-间隔指针词典**：将所有词项拼接成单一字符串，每K个词项存储完整指针，其他仅存储长度和8字节前缀，节省词典空间。

---

## 三、布尔检索效率对比

### 优化策略

**基线策略**：按查询表达式从左到右依次执行，不考虑 posting list 长度差异。

**优化策略**：AND/OR 操作按 posting list 长度升序排序操作数，优先处理短列表，减少中间结果规模。

### 实验结果

| 查询表达式 | 从左到右 | 优化策略 | 性能提升 | 结果数 |
|-----------|---------|---------|---------|-------|
| (ability AND able) OR accept | 0.000197s | 0.000182s | +7.72% | 134 |
| adventure AND (age OR alert) | 0.000286s | 0.000187s | +34.66% | 3 |
| (alone OR amazing) AND NOT activity | 0.001897s | 0.001702s | +10.29% | 98 |
| (allow AND also) OR (alternative AND although) | 0.000087s | 0.000079s | +9.41% | 0 |

**关键结论**：posting list 长度差异越大，优化效果越明显（最高达 34.66%）。对于包含多个 AND 操作的查询，优化效果最显著。优化策略不改变最终结果，所有查询均在毫秒级完成。

---

## 四、索引压缩前后检索效率对比

### 压缩效果

**空间节省**：

| 对比项 | 未压缩大小 | 压缩后大小 | 压缩率 | 节省空间 |
|-------|----------|----------|-------|---------|
| 倒排表 | 1.25 MB | 803 KB | 35.76% | 447 KB |
| 词典 | 699 KB | 628 KB | 10.16% | 71 KB |
| **总体** | **1.949 MB** | **1.431 MB** | **26.58%** | **518 KB** |

倒排表使用 VB+Gap 编码压缩效果显著，词典使用 K-间隔指针压缩节省约 10.16% 空间。

### 查询性能对比

**单词查询测试**（高频词）：

| 查询词 | 未压缩时间 | 压缩时间 | 时间差异 | 文档数 |
|-------|----------|---------|---------|-------|
| please | 0.000587s | 0.001108s | +88.74% | 1745 |
| u | 0.000499s | 0.000883s | +76.96% | 1666 |
| see | 0.000488s | 0.000781s | +59.89% | 1406 |

**AND 查询测试**：

| 查询表达式 | 未压缩时间 | 压缩时间 | 时间差异 | 文档数 |
|-----------|----------|---------|---------|-------|
| please AND u | 0.001840s | 0.002508s | +36.28% | 824 |
| see AND meet | 0.001400s | 0.001921s | +37.21% | 542 |
| u AND meet | 0.001445s | 0.002624s | +81.55% | 574 |
| please AND u AND see | 0.002475s | 0.003574s | +44.41% | 391 |
| u AND see AND meet | 0.002313s | 0.003463s | +49.71% | 286 |

**OR 查询测试**：

| 查询表达式 | 未压缩时间 | 压缩时间 | 时间差异 | 文档数 |
|-----------|----------|---------|---------|-------|
| please OR u | 0.001631s | 0.002387s | +46.28% | 2587 |
| see OR meet | 0.001662s | 0.002359s | +42.00% | 2241 |
| please OR u OR see | 0.003208s | 0.004499s | +40.23% | 3037 |

### 综合评价

**压缩索引优势**：存储空间节省 26.58%（518 KB），降低 I/O 瓶颈，适用于大规模数据和分布式系统。

**查询开销分析**：查询时间增加 36-89%，主要来自 VB 解码和 Gap 还原开销。单词查询解码开销最大（+60-89%），AND/OR 组合查询相对较小（+36-50%）。绝对时间仍在毫秒级，实际体验差异不大。

**应用建议**：存储资源受限、大规模数据处理、分布式系统优先选择压缩索引；实时查询要求极高、存储充足场景使用未压缩索引。混合策略对高频词使用未压缩索引，对低频词使用压缩索引，综合性能最优。

---

## 五、位置型倒排索引与短语检索

### 存储效率分析

| 索引类型 | 倒排表大小 | 相对标准索引 | 特点 |
|---------|----------|------------|------|
| 标准倒排索引 | 1.25 MB | 基准（1.0x） | 仅记录文档ID |
| 位置型索引（未压缩） | 3528 KB | 2.76倍 | 记录所有位置信息 |
| 位置型索引（压缩） | 1635 KB | 1.28倍 | VB+Gap双层压缩 |

采用 VB+Gap 双层压缩（文档ID序列和位置序列分别压缩），位置型倒排表压缩率达 53.65%，压缩后仅比标准索引大 28%，空间开销可控。

**查询性能**：相比标准索引增加 15-30% 查询时间（需要位置验证），但结果精确度显著提升，能够区分词序，精确匹配专有名词。

### 应用场景

**推荐使用位置型索引**：学术论文检索、法律文档检索、新闻检索（人名地名）、代码搜索（函数名API调用）。

**推荐使用标准索引**：简单关键词搜索、存储空间受限、实时性要求极高、布尔查询为主。

**混合策略**：对高频通用词使用标准索引（节省空间），对专业术语和专有名词使用位置型索引（提高精度）。

---

## 六、向量空间模型文档检索

`VectorSpaceRetrieval` 类实现基于 TF-IDF 和余弦相似度的向量空间模型文档检索系统，支持多种 TF-IDF 计算变体和灵活的查询模式。

### 模块架构

**数据加载模块**：加载倒排索引文件（`inverted_index.txt`）和规范化文档（`output/normalized_events/*.txt`），构建词项-文档频率矩阵，统计文档集合信息（总文档数 10,514、词汇表大小 2,538、平均文档长度 94.4 词项）。

**查询处理模块**：复用 `EventTextProcessor` 对查询进行分词和规范化，构建查询 TF-IDF 向量，计算查询-文档余弦相似度，按相似度降序排序并返回 Top-K 结果。

**结果输出模块**：控制台显示检索结果（包含文档规范化原文），可以选择保存结果到 JSON 和文本文件，生成详细统计报告（查询词项覆盖率、文档分布、词项频率分析）。

### TF-IDF 计算方法

系统实现四种 TF-IDF 计算变体，支持程序员通过参数灵活选择：

| 方法 | 公式 | 特点 |
|------|------|------|
| 标准方法 | `tf × log(N/df)` | 默认方法，直接使用词频 |
| 对数频率 | `(1 + log(tf)) × log(N/df)` | 对高频词进行平滑，避免过度权重 |
| 增强频率 | `(0.5 + 0.5×tf/max_tf) × log(N/df)` | 规范化词频至 [0.5, 1.0]，平衡长短文档 |
| 二元频率 | `(1 if tf>0 else 0) × log(N/df)` | 仅考虑词项出现与否，忽略频率差异 |

### 查询模式

**测试模式**：自动执行 10 个预定义查询（music, food, art, technology innovation, education, health, business entrepreneurship, travel adventure, science research discovery, culture tradition heritage），生成详细检索报告和统计信息。

**交互式模式**：用户输入自定义查询，实时显示检索结果，支持动态切换 TF-IDF 方法（命令：`method log`），提供配置查看（`config`）和方法列表（`methods`）等帮助功能。

### 检索结果示例

**查询**：`music`

**Top-3 结果**：

| 排名 | 文档ID | 相似度 | 文档长度 | 匹配词项 | 规范化原文摘要 |
|------|--------|--------|----------|----------|----------------|
| 1 | 11095502 | 0.6346 | 277 词项 | 1/1 (music) | ali amr music festival addition perform group ali amr experiment... |
| 2 | 112001832 | 0.5461 | 29 词项 | 1/1 (music) | bar new_haven live music every wednesday night... |
| 3 | 110826922 | 0.5296 | 48 词项 | 1/1 (music) | monday morning music meetup look meet parent make friend... |

**输出文件结构**：

```text
output_retrieval/
├── query_results/
│   ├── query_1_results.json          # 结构化数据（含 normalized_text）
│   ├── query_1_results.txt           # 可读文本格式（含规范化原文）
│   └── ...                           # 其他查询结果
├── retrieval_report.txt              # 综合报告（系统统计、查询统计、词项分析）
└── retrieval_statistics.json         # 统计信息（相似度分布、查询覆盖率）
```

### 检索性能评估

**查询响应时间**：所有查询均在毫秒级完成，包括加载索引、构建向量、计算相似度、排序等全流程。

**文档覆盖率**：对于单词查询（如 `music`），系统找到 10,514 个相关文档（全部文档），返回 Top-3 最相关结果。相似度范围 0.53-0.63，表明存在明确相关文档。

**词项匹配精度**：系统通过预处理保持查询与文档的一致性（停用词过滤、词形还原），查询词 `music` 精确匹配文档中的 `music` 词项，避免词形变化导致的匹配失败。

### 应用建议

**适用场景**：需要按相关度排序的检索任务（与布尔检索的二值判断不同），支持自然语言查询（多词短语），适合推荐系统、问答系统、文档相似度分析。

**方法选择**：通用场景使用标准方法，长文档场景使用增强频率方法（平衡长度差异），高频词过度权重场景使用对数频率方法，专有名词检索使用二元方法（强调出现与否）。

**性能优化**：预构建文档向量（避免重复计算），使用近似最近邻算法（如 LSH、HNSW）加速大规模检索，对高频词设置权重上限（防止"the"等词主导相似度）。

---
